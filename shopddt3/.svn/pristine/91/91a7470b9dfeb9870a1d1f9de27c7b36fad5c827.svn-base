<?php
namespace Admin\Controller;
use BizService\UserService;
use Think\Controller;
use Think\Model;
use Think\Upload; 

class TempstyleController extends BaseController {
	
	public function _initialize() {
      
    }
	/**
	 * 模板列表
	 * @author zhanghui
	 */
    public function stylelist(){
	    $data=D("tempstyle")->getlist();
		$this->assign('data',$data);
		$this->display("style_list");
    }
	
	/**
	 * 模板添加
	 * @author zhanghui
	 */
    public function styleadd(){
		$this->display("style_add");
    }
    
	/**
	 * 模板修改
	 * @author zhanghui
	 */
    public function styleedit(){
	    //获取商城信息
		$shop_proxy=get_shop_proxy();
		if (IS_POST) { // 提交表单
		    $id=I('style_id');
		    $data['style_type'] = I('style_type');
			$data['style_title'] = I('style_title');
			$data['style_num'] = I('style_num');
			$data['style_is_used'] = I('style_is_used');
		    $data['style_order'] = I('style_order');
			//保存数据
			if (false !== D('tempstyle')->where('style_id='.$id)->data($data)->save()) {
				$this->success ( '编辑成功！', U ( '/admin/tempstyle/stylelist' ) );
			} else {
				$error = D('temp')->getError ();
				$this->error ( empty ( $error ) ? '未知错误！' : $error );
			}
		} else {
		    $style_id = I ( 'style_id' );
			/* 获取分类信息 */
			$info = $style_id ?D('tempstyle')->info ( $style_id ) : '';
			$this->assign ( 'info', $info );
			$this->assign ( 'style_id', $style_id );
			$this->display("style_edit");
		}
		
    }
	
	/**
	 * 模板删除
	 * @author zhanghui
	 */
    public function styledel(){
	   
    }
	
	
    //模板七，内容生成
    public function Style7()
    {
		//调取代理信息
        $shop_info = get_shop_proxy();
		$shop_id=$shop_info['shop_id']?$shop_info['shop_id']:1;
		$order="  order by a.goods_commonid desc";
		
		//获取传来的信息
		$info=$_POST['info'];
		$page         = isset($_REQUEST['counting'])   && intval($_REQUEST['counting'])  > 0 ? intval($_REQUEST['counting'])  : 1;
	    $size         = isset($info['info_num'])   && intval($info['info_num'])  > 0 ? intval($info['info_num'])  : 5;
	    $str="";
	   /* if(!empty($info['info_data']['1'])){
		  foreach($info['info_data']['1'] as $key=>$val){
		    $str.="  and   $key like  '%$val%' ";
		  }
	    }
	  
	    if(!empty($info['info_data']['0'])){
		  foreach($info['info_data']['0'] as $key=>$val){
		    $str.=" and   $key = $val ";
		  }
	    }*/

       // $info['info_data']['0']['gc_id']=19;
	    
	    /*if($str!=""||$limit!=""){
		$p_data=   M()->query("select a.* from ddt_goods as a ,ddt_goods_class_relation as b where a.goods_commonid=b.goods_commonid and b.class_id=".$info['info_data']['0']['gc_id']);
		   
	    }*/
		
	   $gc_id=$info['info_data']['0']['gc_id']?$info['info_data']['0']['gc_id']:1;
	   if($gc_id > 1){
		$p_data=   M()->query("select a.* from ddt_goods as a ,ddt_goods_class_relation as b where a.goods_commonid=b.goods_commonid and a.goods_state>0 and a.shop_id= $shop_id   and a.goods_state>0  and b.class_id=".$gc_id);
	    }else{
		 $p_data=   M()->query("select * from ddt_goods  where shop_id= $shop_id  and goods_state>0  ");
		}
		

	    $count = count($p_data);
	    $max_page = ($count> 0) ? ceil($count / $size) : 1;
		if ($page > $max_page)
		{ 
		   $array=array();
		   echo json_encode($array);
		   exit;
		}

		$limit="";
		if($info['info_page']==1&&$info['info_num']>0){
		  $num=$info['info_num'];
		  $statnum=($page-1)*$num;
		  $limit=" $statnum,$num ";
		}
		if($gc_id > 1){
		  $goodslist=   M()->query("select a.* from ddt_goods as a ,ddt_goods_class_relation as b where a.goods_commonid=b.goods_commonid   and a.shop_id= $shop_id   and a.goods_state>0  and a.goods_state>0   and b.class_id=".$gc_id." limit ".$limit.$order);
		}else{
		   $goodslist=   M()->query("select * from ddt_goods where shop_id= $shop_id   and goods_state>0   limit ".$limit.$order);
		}
		
		foreach($goodslist as $key=>$val){
			$goodcommon_info=D('goodscommon')->where('goods_commonid='.$val['goods_commonid'])->find();
			$goodslist[$key]['position_tags']=$goodcommon_info['position_tags'];
			$goodslist[$key]['subtitle']=$goodcommon_info['subtitle'];
		}
		
		
		if($max_page < $page){
		  $array=array();
		  echo json_encode($array);
		}else{
		  echo json_encode($goodslist);
		}
    }
	
	



	
	
}